<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Grow a Garden Stock</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
html,body{background:#060e22;color:#fff;font-family:'Segoe UI','Arial',sans-serif;margin:0;padding:0;min-height:100vh;}
body{padding:0;box-sizing:border-box;}
.main-container{max-width:1450px;margin:40px auto;padding:0;}
.dashboard-row{display:flex;gap:2.2rem;margin:0 auto 2.1rem auto;width:90%;min-width:320px;max-width:100vw;background:none;border-radius:24px;justify-content:flex-start;align-items:stretch;flex-wrap:wrap;}
.dashboard-card{background:linear-gradient(135deg,#1d3147 60%,#232959 100%);border-radius:16px;flex:1 1 230px;min-width:0;padding:2.2rem 2.5rem 1.8rem 2.0rem;display:flex;flex-direction:column;justify-content:center;box-shadow:none;border:none;max-width:700px;margin-right:0;}
.dashboard-label{font-size:1.18em;color:#7db4ee;font-weight:400;letter-spacing:0.08em;text-transform:uppercase;margin-bottom:0.6em;display:flex;align-items:center;gap:0.6em;}
#countdown{color:#23ff97;font-size:2.4em;font-weight:700;letter-spacing:0.04em;display:inline-block;margin-bottom:0.35em;margin-top:0.15em;}
.dashboard-note{color:#56f9b7;font-size:1.2em;font-weight:400;margin-top:0.4em;margin-left:0.1em;letter-spacing:0.01em;opacity:0.82;}
.dashboard-icon{width:1.4em;height:1.4em;display:inline-block;vertical-align:middle;color:#23ff97;opacity:0.82;}
.dashboard-weather-main{font-size:1.7em;font-weight:600;color:#a6cdf8;display:inline-block;vertical-align:middle;margin-top:0.1em;}
.tab-bar-outer{width:100%;margin:0;display:flex;justify-content:center;align-items:center;}
.tab-bar{display:flex;justify-content:center;align-items:center;gap:0.5rem;background:#12234a;padding:0.6rem 0.5rem 0.6rem 0.9rem;border-radius:24px;margin:0 auto 2.2rem auto;width:auto;min-width:200px;max-width:100vw;box-shadow:none;border:3px solid #15284e;flex-wrap:wrap;}
.tab{flex:0 0 auto;padding:0.7rem 2.3rem;border-radius:12px;background:transparent;color:#c2d8ff;font-weight:500;font-size:1.15em;border:none;cursor:pointer;transition:background .2s cubic-bezier(.4,0,.2,1),color .2s cubic-bezier(.4,0,.2,1);outline:none;margin-right:0.1rem;}
.tab.active{background:#2947a9;color:#fff;box-shadow:0 2px 8px #1e3f7a33;}
.tab:focus{outline:2px solid #74aaff;}
.refresh-btn-bottom{display:flex;justify-content:center;width:100%;margin:2.5rem 0 1.5rem 0;}
.refresh-btn{padding:0.67rem 2.2rem;font-size:1.15em;font-weight:600;color:#a9d8ff;background:#233e70;border:none;border-radius:14px;cursor:pointer;transition:background 0.15s,color 0.15s;outline:none;box-shadow:0 1.5px 8px #10306023;}
.refresh-btn:hover,.refresh-btn:focus{background:#3b8af7;color:#fff;}
.section-card{background:var(--card-bg,rgba(21,34,61,0.95));border-radius:18px;box-shadow:var(--shadow,0 4px 24px rgba(0,0,0,0.35));padding:2.2rem 1.4rem 1.4rem 1.4rem;margin-bottom:2rem;position:relative;overflow:hidden;width:100%;min-width:0;margin-left:auto;margin-right:auto;}
.section-header{display:flex;justify-content:flex-start;align-items:flex-end;margin-bottom:1.2rem;flex-wrap:wrap;gap:1.2rem;}
.section-title{font-size:1.3em;color:#b6ccfa;font-weight:600;letter-spacing:0.01em;}
.item-grid{display:grid;grid-template-columns:repeat(5,1fr);gap:1rem;width:100%;}
.item-card.egg-card {
  max-width: 500px;
  width: 98%;       
  min-height: 140px;
  padding-top: 1.1rem;
  padding-bottom: 1.0rem;
  margin-left: auto;
  margin-right: auto;
}

.item-card {
  background:rgba(15,23,42,0.98);
  border-radius:12px;
  box-shadow:0 2px 16px #1e1b4b33;
  display:flex;
  flex-direction:column;
  align-items:center;
  padding:1.1rem 0.4rem 1.0rem 0.4rem;
  transition:box-shadow .2s cubic-bezier(.4,0,.2,1),transform .2s cubic-bezier(.4,0,.2,1);
  border:1.5px solid transparent;
  position:relative;
  min-height:140px;
  width:94%;
  max-width:350px;
  margin-left:auto;
  margin-right:auto;
}
@media (min-width:1401px) {
  .item-grid{grid-template-columns:repeat(4,1fr);}
}
@media (max-width:1400px){.item-grid{grid-template-columns:repeat(3,1fr);}}
@media (max-width:900px){.item-grid{grid-template-columns:repeat(2,1fr);}}
@media (max-width:600px){.item-grid{grid-template-columns:1fr;}}
.item-card:hover{box-shadow:0 4px 32px #2250c355;border-color:#3e5be1;transform:translateY(-2px) scale(1.03);}
.item-name{font-weight:500;font-size:1.07em;color:#e6e9fa;margin-bottom:0.65em;text-align:center;margin-top:0.2em;}
.item-pills{display:flex;flex-direction:column;gap:0.30em;width:100%;align-items:center;margin-top:auto;}
.pill-stock{background:#2e7cff;color:#f3f9ff;border-radius:16px;font-weight:600;font-size:1.07em;padding:0.27em 1em;margin-bottom:0.2em;margin-top:0.05em;box-shadow:0 2px 10px #2955a933;border:1.5px solid #355eb9;}
.pill-price{background:linear-gradient(90deg,#ffe066,#ffe066cc 70%,#ffe066 100%);color:#ad9300;border-radius:16px;font-weight:600;font-size:1.06em;padding:0.18em 0.95em;margin-bottom:0.03em;box-shadow:0 2px 8px #b7a20033;border:1.5px solid #ffe066;}
body, .main-container { zoom: 0.92; }
#creditsModal .credits-title {
  text-align: center;
  width: 100%;
}
.credits-btn{
  padding:0.28em 1.2em;
  font-size:1em;
  border-radius:9px;
  border:none;
  background:#313949;
  color:#e7e7e7;
  font-weight:600;
  cursor:pointer;
  box-shadow:0 1px 4px #0004;
  transition:background 0.13s,color 0.13s;
}
.credits-btn:hover,.credits-btn:focus{
  background:#495470;
  color:#fff;
}
#creditsModalBg{display:none;position:fixed;z-index:10001;top:0;left:0;width:100vw;height:100vh;background:rgba(0,0,0,0.36);}
#creditsModalBg.active{display:block;}
#creditsModal{display:none;position:fixed;z-index:10002;top:50%;left:50%;transform:translate(-50%,-50%);background:#212d47;padding:2.1em 2.2em 1.7em 2.2em;border-radius:18px;box-shadow:0 8px 42px #000a;text-align:center;min-width:270px;min-height:40px;}
#creditsModal.active{display:block;}
.credits-title{font-size:1.25em;color:#ffe066;font-weight:700;margin-bottom:0.6em;}
.credits-row{color:#e6e6e6;margin-bottom:0.7em;font-size:1.08em;}
.credits-link{color:#71aaff;text-decoration:underline;font-weight:600;transition:color .13s;}
.credits-link:hover{color:#ffe066;}
.credits-close{position:absolute;top:0.8em;right:1.1em;background:none;border:none;font-size:1.6em;color:#ffe066;cursor:pointer;font-weight:700;outline:none;}
@media (max-width:900px){.main-container{max-width:100vw;}.dashboard-row,.section-card{min-width:unset;width:98vw;}.tab-bar{min-width:0;width:98vw;flex-wrap:wrap;}.section-card{padding:1.1rem 0.4rem 0.7rem 0.4rem;}}
@media (max-width:600px){.main-container{max-width:100vw;}.dashboard-row,.section-card{min-width:0;width:100vw;padding-left:0;padding-right:0;}.dashboard-card{padding:1.1rem 0.7rem 0.9rem 0.7rem;min-width:0;}.tab-bar{gap:0.25rem;min-width:0;padding:0.4rem 0.2rem 0.4rem 0.3rem;border-radius:14px;font-size:0.98em;}.tab{font-size:1em;padding:0.46rem 0.85rem;border-radius:9px;}.item-grid{grid-template-columns:repeat(auto-fit,minmax(140px,1fr));gap:0.5rem;}.item-card{min-height:100px;padding:0.7rem 0.2rem 0.5rem 0.2rem;max-width:unset;}.item-card.egg-card{max-width:unset;}.section-header{gap:0.55rem;}.section-title{font-size:1.08em;}}
@media (max-width:400px){.main-container,.dashboard-row,.section-card{min-width:0;width:100vw;}.tab-bar-outer{max-width:100vw;}.tab-bar{min-width:0;width:100vw;}.item-grid{grid-template-columns:1fr;}.item-card{min-height:82px;padding:0.3rem 0.08rem 0.2rem 0.08rem;}}
  </style>
</head>
<body>
  <div class="main-container">
    <div id="dashboardRow"></div>
    <div class="tab-bar-outer"><div class="tab-bar" id="tabBar"></div></div>
    <div id="loading">Loading data...</div>
    <div id="content"></div>
    <div id="errorMsg"></div>
    <div class="refresh-btn-bottom">
      <button class="refresh-btn" id="refreshBtnBottom" type="button">Refresh Data</button>
    </div>
  </div>
  <div id="creditsModalBg"></div>
  <div id="creditsModal">
    <button class="credits-close" id="creditsCloseBtn" aria-label="Close Credits">&times;</button>
    <div class="credits-title">Credits</div>
    <div class="credits-row">API by Just3itx</div>
    <a class="credits-link" href="https://github.com/Just3itx/Grow-A-Garden-API?tab=readme-ov-file" target="_blank" rel="noopener">API</a>
  </div>
  <script>
const CATEGORY_LABELS = [
  { key: "seed_stock", label: "Seeds" },
  { key: "eventshop_stock", label: "Honey Event" },
  { key: "cosmetics_stock", label: "Cosmetics" },
  { key: "egg_stock", label: "Eggs" },
  { key: "gear_stock", label: "Gear" }
];

// Restore last opened tab from localStorage if available
const savedTab = localStorage.getItem('lastOpenedTab');
let currentTab = savedTab ? savedTab : 'seed_stock';

let stockRaw = {};
let itemInfo = {};
let restockTimes = {};
let countdownStr = "--";
let countdownInterval = null;
let autoRefreshInterval = null;
let autoRestockInterval = null;
let tabs = [];
let weatherList = [];
let currentWeather = null;
let autoWeatherInterval = null;

function getTabs(stockRaw) {
  const knownLabels = {
    seed_stock: 'Seeds',
    egg_stock: 'Eggs',
    gear_stock: 'Gear',
    cosmetics_stock: 'Cosmetics',
    eventshop_stock: 'Honey Event'
  };
  return Object.keys(stockRaw)
    .filter(cat => !!knownLabels[cat])
    .map(cat => ({ cat, label: knownLabels[cat] }));
}

function renderTabs(selectedCategory, tabs) {
  const tabBar = document.getElementById('tabBar');
  tabBar.innerHTML = '';
  tabs.forEach(({ cat, label }) => {
    const btn = document.createElement('button');
    btn.className = 'tab' + (cat === selectedCategory ? ' active' : '');
    btn.textContent = label;
    btn.onclick = () => {
      currentTab = cat;
      localStorage.setItem('lastOpenedTab', cat);
      renderCategory(cat, tabs);
      fetchRestockTime();
    };
    tabBar.appendChild(btn);
  });
}

function renderDashboardRow() {
  const dash = document.getElementById('dashboardRow');
  dash.innerHTML = '';

  const row = document.createElement('div');
  row.className = 'dashboard-row';

  const restockCard = document.createElement('div');
  restockCard.className = 'dashboard-card';
  restockCard.innerHTML = `
    <div class="dashboard-label">
      <svg class="dashboard-icon" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
        <circle cx="12" cy="12" r="9" stroke-opacity="0.68"/>
        <path d="M12 7v5l3 3" stroke-linecap="round" stroke-linejoin="round"/>
      </svg>
      NEXT REFRESH IN
    </div>
    <span class="dashboard-timer" id="countdown"></span>
    <div class="dashboard-note" id="dashboard-note">Refreshes at the listed interval</div>
  `;

  const weatherCard = document.createElement('div');
  weatherCard.className = 'dashboard-card';
  let weatherName = "No Special Weather Active";
  if (currentWeather && currentWeather.weather_name) {
    weatherName = currentWeather.weather_name.replace(/([A-Z])/g, ' $1').replace(/^ /, '');
  }
  weatherCard.innerHTML = `
    <div class="dashboard-label">WEATHER</div>
    <div style="display:flex;align-items:center;">
      <span class="dashboard-weather-main">${weatherName}</span>
    </div>
  `;

  row.appendChild(restockCard);
  row.appendChild(weatherCard);
  dash.appendChild(row);
  updateCountdownUI();
}

function updateCountdownUI() {
  const timer = document.getElementById('countdown');
  if (timer) timer.textContent = countdownStr;
}

function startCountdown(countdownString) {
  function parseCountdown(str) {
    if (!str) return 0;
    let h = 0, m = 0, s = 0;
    const hm = str.match(/(\d+)h/);
    const mm = str.match(/(\d+)m/);
    const sm = str.match(/(\d+)s/);
    if (hm) h = parseInt(hm[1],10);
    if (mm) m = parseInt(mm[1],10);
    if (sm) s = parseInt(sm[1],10);
    return h*3600 + m*60 + s;
  }
  let sec = parseCountdown(countdownString);
  function fmt(sec) {
    let h = Math.floor(sec/3600);
    let m = Math.floor((sec%3600)/60);
    let s = sec%60;
    if (h > 0) return `${String(h).padStart(2,"0")}h ${String(m).padStart(2,"0")}m ${String(s).padStart(2,"0")}s`;
    else return `${String(m).padStart(2,"0")}m ${String(s).padStart(2,"0")}s`;
  }
  countdownStr = fmt(sec);
  updateCountdownUI();
  if (countdownInterval) clearInterval(countdownInterval);
  countdownInterval = setInterval(() => {
    sec--;
    if (sec < 0) sec = 0;
    countdownStr = fmt(sec);
    updateCountdownUI();
  }, 1000);
}

function renderCategory(cat, tabs) {
  const content = document.getElementById('content');
  content.innerHTML = '';
  renderTabs(cat, tabs);
  renderDashboardRow();

  const section = document.createElement('div');
  section.className = 'section-card';

  const header = document.createElement('div');
  header.className = 'section-header';
  const title = document.createElement('div');
  title.className = 'section-title';
  title.textContent = 'Available ' + tabs.find(t => t.cat === cat).label;
  header.appendChild(title);
  section.appendChild(header);

  const grid = document.createElement('div');
  grid.className = 'item-grid';

  if (stockRaw[cat]) {
    let filtered = stockRaw[cat].filter(stockItem => stockItem.quantity && stockItem.quantity > 0);

    filtered.forEach(stockItem => {
      const info = itemInfo[stockItem.item_id] || {};
      const displayName = stockItem.display_name || info.display_name || stockItem.item_id;
      const card = document.createElement('div');
      card.className = (cat === "egg_stock" ? 'item-card egg-card' : 'item-card');

      if (info.icon || stockItem.icon) {
        const img = document.createElement('img');
        img.src = info.icon || stockItem.icon;
        img.alt = displayName;
        img.style.width = "70px";
        img.style.height = "70px";
        img.style.marginBottom = "0.7em";
        img.style.objectFit = "contain";
        card.appendChild(img);
      }

      const name = document.createElement('div');
      name.className = 'item-name';
      name.textContent = displayName;
      card.appendChild(name);

      const pills = document.createElement('div');
      pills.className = 'item-pills';

      const stockPill = document.createElement('div');
      stockPill.className = 'pill-stock';
      stockPill.textContent = stockItem.quantity;
      pills.appendChild(stockPill);

      const pricePill = document.createElement('div');
      pricePill.className = 'pill-price';

      let price = info.price;
      let currency = (info.currency || '').toLowerCase();

      if (cat === "eventshop_stock") {
        if (!price || price === "0" || isNaN(Number(price)) || Number(price) <= 0 || Number(price) > 9999999) {
          pricePill.textContent = "?";
        }
        else if (
          displayName.toLowerCase().includes("lavender") ||
          displayName.toLowerCase().includes("nectarshade")
        ) {
          pricePill.textContent = `${price} Honey`;
        }
        else if (currency === "honey") {
          pricePill.textContent = `${price} Honey`;
        }
        else {
          pricePill.textContent = `${price}c`;
        }
      } else {
        if (!price || price === "0" || isNaN(Number(price)) || Number(price) <= 0 || Number(price) > 9999999) {
          pricePill.textContent = "?";
        } else if (currency === "honey") {
          pricePill.textContent = `${price} Honey`;
        } else {
          pricePill.textContent = `${price}c`;
        }
      }
      pills.appendChild(pricePill);

      card.appendChild(pills);
      grid.appendChild(card);
    });
  }
  section.appendChild(grid);
  content.appendChild(section);
  updateCountdownUI();
}

async function fetchRestockTime() {
  try {
    const res = await fetch("https://growagardenapi.vercel.app/api/stock/Restock-Time");
    if (!res.ok) throw new Error();
    const json = await res.json();
    restockTimes = json;
    startCountdown(json?.seeds?.countdown ?? "00m 00s");
  } catch {
    startCountdown("00m 00s");
  }
}
async function fetchWeather() {
  try {
    const res = await fetch('https://growagardenapi.vercel.app/api/GetWeather');
    if (!res.ok) throw new Error();
    const json = await res.json();
    weatherList = Array.isArray(json.weather) ? json.weather : [];
    currentWeather = weatherList.find(w => w.active) || null;
    renderDashboardRow();
  } catch {}
}

async function reloadAll(manual) {
  const loading = document.getElementById('loading');
  if (manual) loading.style.display = 'block';
  const errorMsg = document.getElementById('errorMsg');
  errorMsg.textContent = '';
  try {
    const [infoRes, stockRes] = await Promise.all([
      fetch('https://api.joshlei.com/v2/growagarden/info'),
      fetch('https://api.joshlei.com/v2/growagarden/stock')
    ]);
    if (!infoRes.ok || !stockRes.ok) throw new Error('API error');
    const infoJson = await infoRes.json();
    const stockJson = await stockRes.json();

    itemInfo = {};
    (infoJson || []).forEach(item => {
      itemInfo[item.item_id] = item;
    });
    stockRaw = (stockJson || {});
    loading.style.display = 'none';

    tabs = getTabs(stockRaw);
    if (!tabs.find(t => t.cat === currentTab)) currentTab = tabs[0]?.cat || '';
    renderCategory(currentTab, tabs);

  } catch (err) {
    document.getElementById('loading').style.display = 'none';
    errorMsg.textContent = 'Failed to load data from API.';
    console.error('Fetch error:', err);
  }
}

document.getElementById('refreshBtnBottom').onclick = () => {
  reloadAll(true);
  fetchRestockTime();
  fetchWeather();
};

if (autoRefreshInterval) clearInterval(autoRefreshInterval);
autoRefreshInterval = setInterval(() => {
  reloadAll(false);
  fetchWeather();
}, 3000);

if (autoRestockInterval) clearInterval(autoRestockInterval);
autoRestockInterval = setInterval(() => {
  fetchRestockTime();
}, 3000);

if (autoWeatherInterval) clearInterval(autoWeatherInterval);
autoWeatherInterval = setInterval(fetchWeather, 3000);

reloadAll(false);
fetchWeather();
fetchRestockTime();

const creditsBtn = document.getElementById('footerCreditsBtn');
const creditsModal = document.getElementById('creditsModal');
const creditsModalBg = document.getElementById('creditsModalBg');
const creditsCloseBtn = document.getElementById('creditsCloseBtn');

function showCreditsModal(show) {
  creditsModal.classList.toggle('active', show);
  creditsModalBg.classList.toggle('active', show);
  if (show) creditsModal.focus();
}
if (creditsBtn) {
  creditsBtn.addEventListener('click', () => showCreditsModal(true));
  creditsBtn.addEventListener('keydown', e => { if (e.key === 'Enter') showCreditsModal(true); });
}
if (creditsModalBg) creditsModalBg.addEventListener('click', () => showCreditsModal(false));
if (creditsCloseBtn) creditsCloseBtn.addEventListener('click', () => showCreditsModal(false));
document.addEventListener('keydown', e => { if (e.key === "Escape") showCreditsModal(false); });

// Please credit me about this if you are gonna use it.
  </script>
</body>
</html>
