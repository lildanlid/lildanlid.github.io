<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>JavaScript Deobfuscator</title>
  <style>
    body {
      background-color: #000;
      color: #0f0;
      font-family: monospace;
      padding: 20px;
    }
    h1 {
      color: #0f0;
      font-size: 24px;
      display: flex;
      align-items: center;
    }
    h1 img {
      width: 28px;
      margin-right: 10px;
    }
    textarea {
      width: 100%;
      height: 300px;
      background: #000;
      color: #0f0;
      border: 1px solid #0f0;
      padding: 10px;
      margin-bottom: 10px;
      font-family: monospace;
    }
    #dropZone {
      border: 2px dashed #0f0;
      padding: 30px;
      text-align: center;
      margin-bottom: 10px;
    }
    button {
      background: #000;
      border: 1px solid #0f0;
      color: #0f0;
      padding: 10px 20px;
      cursor: pointer;
      margin-right: 10px;
      display: inline-flex;
      align-items: center;
    }
    button img {
      width: 20px;
      margin-right: 8px;
    }
    button:hover {
      background: #0f0;
      color: #000;
    }
  </style>

  <!-- Link to Google Material Icons -->
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
</head>
<body>
  <h1>
    <span class="material-icons">laptop</span>
    JavaScript Deobfuscator
  </h1>

  <div id="dropZone">
    <span class="material-icons" style="font-size: 32px;">folder_open</span>
    Drag & Drop a JS file here
  </div>

  <textarea id="input" placeholder="Or paste obfuscated code here..."></textarea>

  <button onclick="process()">
    <span class="material-icons">cleaning_services</span>
    Deobfuscate + Beautify
  </button>

  <button onclick="beautifyOnly()">
    <span class="material-icons">brush</span>
    Beautify Only
  </button>

  <textarea id="output" placeholder="Result appears here..."></textarea>

  <!-- Beautifier -->
  <script src="https://cdn.jsdelivr.net/npm/js-beautify@1.14.0/js/lib/beautify.js"></script>
  <script>
    // Drag & Drop functionality
    const dropZone = document.getElementById('dropZone');
    dropZone.addEventListener('dragover', e => {
      e.preventDefault();
      dropZone.style.borderColor = '#fff';
    });
    dropZone.addEventListener('dragleave', () => {
      dropZone.style.borderColor = '#0f0';
    });
    dropZone.addEventListener('drop', e => {
      e.preventDefault();
      dropZone.style.borderColor = '#0f0';
      const file = e.dataTransfer.files[0];
      if (file && file.name.endsWith('.js')) {
        const reader = new FileReader();
        reader.onload = ev => {
          document.getElementById('input').value = ev.target.result;
        };
        reader.readAsText(file);
      }
    });

    // Beautify Only (without deobfuscation)
    function beautifyOnly() {
      const input = document.getElementById('input').value;
      const output = js_beautify(input, { indent_size: 2 });
      document.getElementById('output').value = output;
    }

    // Deobfuscate and Beautify
    function process() {
      let code = document.getElementById('input').value;

      // Handle mappings like _0x5956() and _0x47a1(x)
      const arrayMatch = code.match(/var (_0x\w+)\s*=\s*\[(.*?)\];/s);
      if (arrayMatch) {
        const arrayName = arrayMatch[1];
        const arrayRaw = `[${arrayMatch[2]}]`;

        let mappingArray;
        try {
          mappingArray = eval(arrayRaw);
        } catch (e) {
          alert("❌ Failed to parse mapping array.");
          return;
        }

        // Find all the calls like _0x47a1(0x1a) and replace them
        const callRegex = new RegExp(arrayName + '\\((0x[0-9a-f]+)\\)', 'gi');
        code = code.replace(callRegex, (_, hex) => {
          const index = parseInt(hex, 16);
          const val = mappingArray[index];
          return typeof val === 'string' ? `"${val}"` : '""';
        });
      }

      // Handle nested function decoding like _0x47a1() with _0x5956()
      const funcMatch = code.match(/function (\w+)\((.*?)\)\s*{[\s\S]*?return (\w+)\(\1\[\w+\]\)/);
      if (funcMatch) {
        const funcName = funcMatch[1];
        const arrayName = funcMatch[3];

        // Attempt to extract the array and decode it
        const arrayMatch2 = code.match(new RegExp(`var (${arrayName})\\s*=\\s*\\[(.*?)\\];`));
        if (arrayMatch2) {
          const newArrayRaw = `[${arrayMatch2[2]}]`;
          let newArray;
          try {
            newArray = eval(newArrayRaw);
          } catch (e) {
            alert("❌ Failed to parse nested mapping array.");
            return;
          }

          // Replace all calls to the function with decoded values
          const funcCallRegex = new RegExp(`${funcName}\\((0x[0-9a-f]+)\\)`, 'gi');
          code = code.replace(funcCallRegex, (_, hex) => {
            const index = parseInt(hex, 16);
            const val = newArray[index];
            return typeof val === 'string' ? `"${val}"` : '""';
          });
        }
      }

      // Beautify the code after deobfuscation
      const beautified = js_beautify(code, { indent_size: 2 });
      document.getElementById('output').value = beautified;
    }
  </script>
</body>
</html>
