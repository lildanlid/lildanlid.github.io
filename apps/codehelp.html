<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ChatGPT Coding Assistant</title>
  <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    /* Previous styles remain the same */
    .rate-limit-info {
      background-color: #fff3cd;
      color: #856404;
      padding: 8px;
      border-radius: 4px;
      margin-bottom: 8px;
      border-left: 4px solid #ffc107;
    }
    .token-counter {
      font-size: 0.75rem;
      color: #6c757d;
      margin-top: 4px;
    }
    .progress-bar {
      height: 4px;
      background-color: #e9ecef;
      border-radius: 2px;
      overflow: hidden;
      margin-top: 2px;
    }
    .progress-fill {
      height: 100%;
      background-color: #28a745;
      transition: width 0.3s ease;
    }
  </style>
</head>
<body>
  <div id="root"></div>

  <script type="text/babel">
    const { useState, useRef, useEffect } = React;

    function CodingChatbot() {
      // State variables
      const [messages, setMessages] = useState([]);
      const [inputValue, setInputValue] = useState('');
      const [apiKey, setApiKey] = useState(localStorage.getItem('chatgpt-api-key') || '');
      const [isLoading, setIsLoading] = useState(false);
      const [error, setError] = useState('');
      const [showApiInput, setShowApiInput] = useState(!apiKey);
      const [rateLimitInfo, setRateLimitInfo] = useState(null);
      const [tokenUsage, setTokenUsage] = useState({ used: 0, estimatedLimit: 40000 });
      const [retryCount, setRetryCount] = useState(0);
      const messagesEndRef = useRef(null);
      const apiInputRef = useRef(null);

      // Initialize with welcome message
      useEffect(() => {
        if (messages.length === 0) {
          setMessages([{
            id: '1',
            text: 'Hello! I\'m your AI coding assistant. How can I help you today?',
            sender: 'ai'
          }]);
        }
      }, []);

      // Save messages and API key to localStorage
      useEffect(() => {
        localStorage.setItem('chatgpt-messages', JSON.stringify(messages));
      }, [messages]);
      
      useEffect(() => {
        if (apiKey) {
          localStorage.setItem('chatgpt-api-key', apiKey);
        }
      }, [apiKey]);

      // Auto-scroll to bottom
      const scrollToBottom = () => {
        messagesEndRef.current?.scrollIntoView({ behavior: 'smooth' });
      };

      useEffect(() => {
        scrollToBottom();
      }, [messages]);

      // Calculate token usage (approximation)
      const calculateTokens = (text) => {
        // Rough estimation: 1 token â‰ˆ 4 characters
        return Math.ceil(text.length / 4);
      };

      // Call ChatGPT API with retry logic
      const callChatGPTAPI = async (prompt, retryAfter = null) => {
        if (retryAfter) {
          await new Promise(resolve => setTimeout(resolve, retryAfter * 1000));
        }

        setIsLoading(true);
        setError('');
        try {
          const response = await fetch('https://api.openai.com/v1/chat/completions', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'Authorization': `Bearer ${apiKey}`
            },
            body: JSON.stringify({
              model: 'gpt-3.5-turbo',
              messages: [
                {
                  role: 'system',
                  content: 'You are a helpful coding assistant. Provide clear, concise answers with code examples when appropriate.'
                },
                {
                  role: 'user',
                  content: prompt
                }
              ],
              temperature: 0.7
            })
          });

          // Handle rate limits
          if (response.status === 429) {
            const retryAfter = parseInt(response.headers.get('Retry-After')) || 20;
            const resetTime = new Date(Date.now() + retryAfter * 1000).toLocaleTimeString();
            
            setRateLimitInfo({
              message: `Rate limit exceeded. Please wait until ${resetTime} and try again.`,
              retryAfter,
              resetTime
            });
            
            throw new Error('rate_limit');
          }

          if (!response.ok) {
            if (response.status === 401) {
              throw new Error('Invalid API key. Please check your key and try again.');
            } else {
              throw new Error(`API request failed with status ${response.status}`);
            }
          }

          const data = await response.json();
          
          // Update token usage
          const tokensUsed = data.usage?.total_tokens || calculateTokens(prompt) + calculateTokens(data.choices[0].message.content);
          setTokenUsage(prev => ({
            ...prev,
            used: prev.used + tokensUsed
          }));

          return data.choices[0].message.content;
        } catch (error) {
          console.error('API Error:', error);
          if (error.message === 'rate_limit' && retryCount < 2) {
            setRetryCount(prev => prev + 1);
            return callChatGPTAPI(prompt, 20); // Retry after 20 seconds
          }
          setError(error.message);
          return null;
        } finally {
          setIsLoading(false);
        }
      };

      const handleSendMessage = async () => {
        if (!inputValue.trim()) {
          setError('Please enter a message');
          return;
        }

        if (!apiKey.trim()) {
          setError('Please enter your API key');
          setShowApiInput(true);
          return;
        }

        // Add user message
        const userMessage = {
          id: Date.now().toString(),
          text: inputValue,
          sender: 'user'
        };

        setMessages(prev => [...prev, userMessage]);
        setInputValue('');
        setRateLimitInfo(null);
        setRetryCount(0);

        // Call ChatGPT API
        const aiResponse = await callChatGPTAPI(inputValue);
        
        if (aiResponse) {
          // Add AI response
          setMessages(prev => [...prev, {
            id: Date.now().toString() + 1,
            text: aiResponse,
            sender: 'ai',
            isCode: aiResponse.includes('```')
          }]);
        }
      };

      // Handle API key submission
      const handleApiKeySubmit = () => {
        if (apiKey.trim()) {
          setShowApiInput(false);
          setError('');
        } else {
          setError('Please enter a valid API key');
        }
      };

      // Format message with code blocks
      const formatMessage = (text, isCode) => {
        if (isCode) {
          const codeBlocks = text.match(/```[\s\S]*?```/g) || [];
          let formattedText = text;
          
          codeBlocks.forEach((block, i) => {
            formattedText = formattedText.replace(block, `CODEBLOCK${i}`);
          });
          
          const paragraphs = formattedText.split('\n').filter(p => p.trim());
          
          return paragraphs.map((paragraph, i) => {
            if (paragraph.startsWith('CODEBLOCK')) {
              const blockIndex = parseInt(paragraph.replace('CODEBLOCK', ''));
              const code = codeBlocks[blockIndex].replace(/```(\w*)\n?/, '').replace(/```$/, '');
              return (
                <pre key={i} className="code-block">
                  {code}
                </pre>
              );
            }
            return <p key={i} className="mb-2">{paragraph}</p>;
          });
        }
        
        return text.split('\n').map((line, i) => (
          <p key={i} className="mb-1">{line}</p>
        ));
      };

      // Token usage percentage
      const tokenUsagePercent = Math.min(Math.round((tokenUsage.used / tokenUsage.estimatedLimit) * 100), 100);

      return (
        <div className="flex flex-col w-full max-w-2xl h-[600px] bg-white rounded-lg shadow-lg overflow-hidden">
          {/* Header */}
          <div className="p-4 bg-blue-600 text-white flex justify-between items-center">
            <div>
              <h1 className="text-xl font-bold">ChatGPT Coding Assistant</h1>
              <p className="text-sm opacity-80">Powered by OpenAI API</p>
            </div>
            {!showApiInput && (
              <button 
                onClick={() => setShowApiInput(true)}
                className="text-sm bg-blue-700 hover:bg-blue-800 px-3 py-1 rounded"
              >
                Change API Key
              </button>
            )}
          </div>

          {/* API Key Input */}
          {showApiInput && (
            <div className="p-4 border-b border-gray-200 bg-gray-50">
              <div className="flex items-center gap-2">
                <input
                  type="password"
                  ref={apiInputRef}
                  value={apiKey}
                  onChange={(e) => setApiKey(e.target.value)}
                  placeholder="Enter your OpenAI API key"
                  className="flex-1 p-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                  onKeyPress={(e) => e.key === 'Enter' && handleApiKeySubmit()}
                />
                <button
                  onClick={handleApiKeySubmit}
                  className="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500"
                >
                  Save
                </button>
              </div>
              <div className="mt-2 text-sm text-gray-600">
                Get your API key from <a href="https://platform.openai.com/api-keys" target="_blank" rel="noopener noreferrer" className="text-blue-600 hover:underline">OpenAI Platform</a>
              </div>
            </div>
          )}

          {/* Messages */}
          <div className="flex-1 p-4 overflow-y-auto">
            {rateLimitInfo && (
              <div className="rate-limit-info mb-4">
                <p>{rateLimitInfo.message}</p>
                <p className="text-sm mt-1">
                  <button 
                    onClick={() => callChatGPTAPI(messages[messages.length-1].text)}
                    className="text-blue-600 hover:underline mr-2"
                  >
                    Retry Now
                  </button>
                  or wait until {rateLimitInfo.resetTime}
                </p>
              </div>
            )}

            {error && !isLoading && (
              <div className="error-message mb-4">
                {error}
                {error.includes('Invalid API key') && (
                  <button 
                    onClick={() => setShowApiInput(true)}
                    className="ml-2 text-blue-600 hover:underline"
                  >
                    Update Key
                  </button>
                )}
              </div>
            )}

            {messages.map(message => (
              <div
                key={message.id}
                className={`mb-4 p-3 rounded-lg max-w-[80%] ${message.sender === 'user' ? 'user-message' : 'ai-message'}`}
              >
                {formatMessage(message.text, message.isCode)}
              </div>
            ))}

            {isLoading && (
              <div className="mb-4 p-3 rounded-lg max-w-[80%] mr-auto bg-gray-100 text-gray-800">
                <div className="typing-indicator">
                  <div className="typing-dot"></div>
                  <div className="typing-dot"></div>
                  <div className="typing-dot"></div>
                </div>
              </div>
            )}
            <div ref={messagesEndRef} />
          </div>

          {/* Token Usage */}
          <div className="px-4 pt-2 pb-1 border-t border-gray-200 bg-gray-50">
            <div className="flex justify-between items-center text-xs text-gray-600">
              <span>Token Usage: {tokenUsage.used.toLocaleString()} / {tokenUsage.estimatedLimit.toLocaleString()}</span>
              <span>{tokenUsagePercent}%</span>
            </div>
            <div className="progress-bar">
              <div 
                className="progress-fill" 
                style={{ width: `${tokenUsagePercent}%`, backgroundColor: tokenUsagePercent > 80 ? '#dc3545' : tokenUsagePercent > 50 ? '#ffc107' : '#28a745' }}
              ></div>
            </div>
            {tokenUsagePercent > 80 && (
              <p className="text-xs text-red-600 mt-1">
                Approaching rate limits. Consider upgrading your plan at <a href="https://platform.openai.com/account/billing" target="_blank" rel="noopener noreferrer" className="underline">OpenAI</a>.
              </p>
            )}
          </div>

          {/* Input Area */}
          <div className="p-4 border-t border-gray-200 bg-white">
            <div className="flex gap-2">
              <input
                type="text"
                value={inputValue}
                onChange={(e) => setInputValue(e.target.value)}
                onKeyPress={(e) => e.key === 'Enter' && handleSendMessage()}
                placeholder="Type your message..."
                className="flex-1 p-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                disabled={isLoading}
              />
              <button
                onClick={handleSendMessage}
                disabled={!inputValue.trim() || !apiKey || isLoading}
                className="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 disabled:opacity-50 disabled:cursor-not-allowed"
              >
                {isLoading ? 'Sending...' : 'Send'}
              </button>
            </div>
          </div>
        </div>
      );
    }

    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(<CodingChatbot />);
  </script>
</body>
</html>
