<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ChatGPT Coding Assistant</title>
  <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body {
      font-family: 'Inter', sans-serif;
      background-color: #f3f4f6;
      min-height: 100vh;
      display: flex;
      justify-content: center;
      align-items: center;
      padding: 20px;
    }
    
    .code-block {
      font-family: 'Courier New', monospace;
      background-color: #1e293b;
      color: #86efac;
      padding: 12px;
      border-radius: 6px;
      overflow-x: auto;
      margin: 8px 0;
      tab-size: 2;
    }
    
    .user-message {
      background-color: #3b82f6;
      color: white;
      margin-left: auto;
    }
    
    .ai-message {
      background-color: #e5e7eb;
      color: #111827;
      margin-right: auto;
    }
    
    .chat-container {
      height: 600px;
      box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1);
    }
    
    .message-container {
      scrollbar-width: thin;
      scrollbar-color: #cbd5e1 #f1f5f9;
    }
    
    .message-container::-webkit-scrollbar {
      width: 8px;
    }
    
    .message-container::-webkit-scrollbar-track {
      background: #f1f5f9;
    }
    
    .message-container::-webkit-scrollbar-thumb {
      background-color: #cbd5e1;
      border-radius: 20px;
    }
    
    .file-upload-container {
      position: relative;
      overflow: hidden;
      display: inline-block;
    }
    
    .file-upload-btn {
      border: 1px dashed #9ca3af;
      border-radius: 0.375rem;
      padding: 0.5rem 1rem;
      font-size: 0.875rem;
      cursor: pointer;
      transition: all 0.2s;
    }
    
    .file-upload-btn:hover {
      background-color: #f3f4f6;
    }
    
    .file-upload-input {
      position: absolute;
      left: 0;
      top: 0;
      opacity: 0;
      width: 100%;
      height: 100%;
      cursor: pointer;
    }
    
    .file-info {
      margin-top: 0.5rem;
      font-size: 0.875rem;
      color: #6b7280;
    }
    
    .typing-indicator {
      display: flex;
      padding: 8px;
    }
    
    .typing-dot {
      width: 8px;
      height: 8px;
      margin: 0 2px;
      background-color: #6b7280;
      border-radius: 50%;
      animation: typingAnimation 1.4s infinite ease-in-out;
    }
    
    .typing-dot:nth-child(1) {
      animation-delay: 0s;
    }
    
    .typing-dot:nth-child(2) {
      animation-delay: 0.2s;
    }
    
    .typing-dot:nth-child(3) {
      animation-delay: 0.4s;
    }
    
    @keyframes typingAnimation {
      0%, 60%, 100% { transform: translateY(0); }
      30% { transform: translateY(-5px); }
    }
    
    .error-message {
      background-color: #fee2e2;
      color: #b91c1c;
      padding: 8px;
      border-radius: 4px;
      margin-bottom: 8px;
    }
  </style>
</head>
<body>
  <div id="root"></div>

  <script type="text/babel">
    const { useState, useRef, useEffect } = React;

    function CodingChatbot() {
      // Load saved data from localStorage
      const savedApiKey = localStorage.getItem('chatgpt-api-key') || '';
      const savedMessages = JSON.parse(localStorage.getItem('chatgpt-messages') || '[]') || [
        {
          id: '1',
          text: 'Hello! I\'m your AI coding assistant. Ask me anything about programming or upload code files for review.',
          sender: 'ai'
        }
      ];
      
      const [messages, setMessages] = useState(savedMessages);
      const [inputValue, setInputValue] = useState('');
      const [uploadedFile, setUploadedFile] = useState(null);
      const [fileName, setFileName] = useState('');
      const [apiKey, setApiKey] = useState(savedApiKey);
      const [isLoading, setIsLoading] = useState(false);
      const [showApiInput, setShowApiInput] = useState(!savedApiKey);
      const [error, setError] = useState('');
      const messagesEndRef = useRef(null);
      const fileInputRef = useRef(null);
      const apiInputRef = useRef(null);

      // Save messages and API key to localStorage when they change
      useEffect(() => {
        localStorage.setItem('chatgpt-messages', JSON.stringify(messages));
      }, [messages]);
      
      useEffect(() => {
        if (apiKey) {
          localStorage.setItem('chatgpt-api-key', apiKey);
        }
      }, [apiKey]);

      const scrollToBottom = () => {
        messagesEndRef.current?.scrollIntoView({ behavior: 'smooth' });
      };

      useEffect(() => {
        scrollToBottom();
      }, [messages]);

      const callChatGPTAPI = async (prompt) => {
        setIsLoading(true);
        setError('');
        try {
          const response = await fetch('https://api.openai.com/v1/chat/completions', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'Authorization': `Bearer ${apiKey}`
            },
            body: JSON.stringify({
              model: 'gpt-3.5-turbo',
              messages: [
                {
                  role: 'system',
                  content: 'You are a helpful coding assistant. Provide clear, concise answers with code examples when appropriate. Format code snippets properly.'
                },
                {
                  role: 'user',
                  content: prompt
                }
              ],
              temperature: 0.7
            })
          });

          if (!response.ok) {
            if (response.status === 429) {
              throw new Error('Rate limit exceeded. Please wait a moment and try again.');
            } else if (response.status === 401) {
              throw new Error('Invalid API key. Please check your key and try again.');
            } else {
              throw new Error(`API request failed with status ${response.status}`);
            }
          }

          const data = await response.json();
          return data.choices[0].message.content;
        } catch (error) {
          console.error('Error calling ChatGPT API:', error);
          setError(error.message);
          return null;
        } finally {
          setIsLoading(false);
        }
      };

      const handleSendMessage = async () => {
        if ((!inputValue.trim() && !uploadedFile) || !apiKey.trim()) {
          setError('Please enter a message or upload a file');
          return;
        }

        // Add user message
        const userMessage = {
          id: Date.now().toString(),
          text: inputValue || `[Uploaded file: ${fileName}]`,
          sender: 'user',
          isFile: !!uploadedFile,
          fileName: fileName
        };

        setMessages(prev => [...prev, userMessage]);
        setInputValue('');
        setUploadedFile(null);
        setFileName('');

        // Prepare prompt for ChatGPT
        let prompt = userMessage.text;
        if (uploadedFile) {
          if (inputValue) {
            prompt = `File: ${fileName}\n\n${inputValue}\n\nPlease analyze this file and answer my question.`;
          } else {
            prompt = `Here's a code file named ${fileName}. Please review it and provide feedback:\n\n${inputValue}`;
          }
        }

        // Call ChatGPT API
        const aiResponse = await callChatGPTAPI(prompt);
        
        if (aiResponse) {
          // Add AI response
          setMessages(prev => [...prev, {
            id: Date.now().toString() + 1,
            text: aiResponse,
            sender: 'ai',
            isCode: aiResponse.includes('```')
          }]);
        }
      };

      const handleFileChange = (e) => {
        const file = e.target.files[0];
        if (file) {
          setUploadedFile(file);
          setFileName(file.name);
          
          // Read file content if it's a text file
          if (file.type.startsWith('text/') || 
              file.name.endsWith('.js') || 
              file.name.endsWith('.html') || 
              file.name.endsWith('.css') ||
              file.name.endsWith('.py') ||
              file.name.endsWith('.java')) {
            const reader = new FileReader();
            reader.onload = (e) => {
              setInputValue(e.target.result);
            };
            reader.readAsText(file);
          } else {
            setInputValue(`Please analyze this file: ${file.name}`);
          }
        }
      };

      const formatMessage = (text, isCode, isFile, fileName) => {
        if (isFile) {
          return (
            <div className="flex items-center">
              <svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor">
                <path fillRule="evenodd" d="M4 4a2 2 0 012-2h4.586A2 2 0 0112 2.586L15.414 6A2 2 0 0116 7.414V16a2 2 0 01-2 2H6a2 2 0 01-2-2V4z" clipRule="evenodd" />
              </svg>
              <span>{fileName}</span>
            </div>
          );
        }
        
        if (isCode) {
          // Extract code blocks from markdown ```
          const codeBlocks = text.match(/```[\s\S]*?```/g) || [];
          let formattedText = text;
          
          // Replace code blocks with placeholders
          codeBlocks.forEach((block, i) => {
            formattedText = formattedText.replace(block, `CODEBLOCK${i}`);
          });
          
          // Split into paragraphs
          const paragraphs = formattedText.split('\n').filter(p => p.trim());
          
          return paragraphs.map((paragraph, i) => {
            if (paragraph.startsWith('CODEBLOCK')) {
              const blockIndex = parseInt(paragraph.replace('CODEBLOCK', ''));
              const code = codeBlocks[blockIndex].replace(/```(\w*)\n?/, '').replace(/```$/, '');
              return (
                <pre key={i} className="code-block">
                  {code}
                </pre>
              );
            }
            return <p key={i} className="mb-2">{paragraph}</p>;
          });
        }
        
        return text.split('\n').map((line, i) => (
          <p key={i} className="mb-1">{line}</p>
        ));
      };

      const handleApiKeySubmit = () => {
        if (apiKey.trim()) {
          setShowApiInput(false);
          localStorage.setItem('chatgpt-api-key', apiKey);
        } else {
          setError('Please enter a valid API key');
        }
      };

      const handleChangeApiKey = () => {
        setShowApiInput(true);
        setTimeout(() => {
          apiInputRef.current?.focus();
        }, 0);
      };

      const clearChat = () => {
        if (confirm('Are you sure you want to clear the chat history?')) {
          setMessages([
            {
              id: '1',
              text: 'Hello! I\'m your AI coding assistant. Ask me anything about programming or upload code files for review.',
              sender: 'ai'
            }
          ]);
        }
      };

      return (
        <div className="flex flex-col w-full max-w-2xl chat-container bg-white rounded-lg overflow-hidden">
          <div className="p-4 bg-blue-600 text-white flex justify-between items-center">
            <div>
              <h1 className="text-xl font-bold">ChatGPT Coding Assistant</h1>
              <p className="text-sm opacity-80">Powered by OpenAI API</p>
            </div>
            {!showApiInput && apiKey && (
              <button 
                onClick={handleChangeApiKey}
                className="text-sm bg-blue-700 hover:bg-blue-800 px-3 py-1 rounded"
              >
                Change API Key
              </button>
            )}
          </div>

          {showApiInput && (
            <div className="p-4 border-b border-gray-200 bg-gray-50">
              <div className="flex items-center gap-2">
                <input
                  type="password"
                  ref={apiInputRef}
                  value={apiKey}
                  onChange={(e) => setApiKey(e.target.value)}
                  placeholder="Enter your OpenAI API key"
                  className="flex-1 p-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                  onKeyPress={(e) => e.key === 'Enter' && handleApiKeySubmit()}
                />
                <button
                  onClick={handleApiKeySubmit}
                  className="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500"
                >
                  Save
                </button>
                <a 
                  href="https://platform.openai.com/api-keys" 
                  target="_blank" 
                  rel="noopener noreferrer"
                  className="ml-2 text-blue-600 hover:underline text-sm whitespace-nowrap"
                >
                  Get API key
                </a>
              </div>
              {error && <div className="error-message mt-2">{error}</div>}
            </div>
          )}

          <div className="flex-1 p-4 overflow-y-auto message-container">
            {error && !isLoading && (
              <div className="error-message mb-4">
                {error}
              </div>
            )}
            {messages.map(message => (
              <div
                key={message.id}
                className={`mb-4 p-3 rounded-lg max-w-[80%] ${message.sender === 'user' ? 'user-message' : 'ai-message'}`}
              >
                {formatMessage(message.text, message.isCode, message.isFile, message.fileName)}
              </div>
            ))}
            {isLoading && (
              <div className="mb-4 p-3 rounded-lg max-w-[80%] mr-auto bg-gray-100 text-gray-800">
                <div className="typing-indicator">
                  <div className="typing-dot"></div>
                  <div className="typing-dot"></div>
                  <div className="typing-dot"></div>
                </div>
              </div>
            )}
            <div ref={messagesEndRef} />
          </div>

          <div className="p-4 border-t border-gray-200 bg-white">
            <div className="flex justify-between mb-2">
              <div className="file-upload-container">
                <button className="file-upload-btn">
                  <svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5 inline mr-1" viewBox="0 0 20 20" fill="currentColor">
                    <path fillRule="evenodd" d="M3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm3.293-7.707a1 1 0 011.414 0L9 10.586V3a1 1 0 112 0v7.586l1.293-1.293a1 1 0 111.414 1.414l-3 3a1 1 0 01-1.414 0l-3-3a1 1 0 010-1.414z" clipRule="evenodd" />
                  </svg>
                  Upload File
                </button>
                <input 
                  type="file" 
                  ref={fileInputRef}
                  onChange={handleFileChange}
                  className="file-upload-input"
                  accept=".js,.html,.css,.txt,.py,.java,.json"
                />
                {fileName && (
                  <div className="file-info">
                    <span className="truncate max-w-xs inline-block">{fileName}</span>
                  </div>
                )}
              </div>
              <button
                onClick={() => clearChat()}
                className="text-sm text-red-600 hover:text-red-800"
              >
                Clear Chat
              </button>
            </div>
            
            <div className="flex gap-2">
              <input
                type="text"
                value={inputValue}
                onChange={(e) => setInputValue(e.target.value)}
                onKeyPress={(e) => e.key === 'Enter' && handleSendMessage()}
                placeholder="Type your message or upload a file..."
                className="flex-1 p-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
              />
              <button
                onClick={handleSendMessage}
                disabled={(!inputValue && !uploadedFile) || !apiKey || isLoading}
                className="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 disabled:opacity-50 disabled:cursor-not-allowed"
              >
                {isLoading ? 'Sending...' : 'Send'}
              </button>
            </div>
          </div>
        </div>
      );
    }

    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(<CodingChatbot />);
  </script>
</body>
</html
